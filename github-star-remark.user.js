// ==UserScript==
// @name         Github Star项目备注
// @namespace    github remark
// @version      0.1
// @description  Github star项目备注
// @author       HCLonely
// @include      /https?:\/\/github.com\/HCLonely.*?tab=stars/
// @run-at       document-end
// @require      https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js
// @compatible   chrome 没有测试其他浏览器的兼容性
// @grant        GM_getValue
// @grant        GM_setValue
// ==/UserScript==

/* global $, GM_getValue, GM_setValue, Swal */
(function () {
  'use strict'
  const data = GM_getValue('data') || {}
  $('.width-full.py-4.border-bottom.color-border-muted').each(function () {
    const item = $(this)
    const head = item.find('h3>a')
    const itemName = head.attr('href')
    const des = data[itemName] || ''
    head.append(`<br/><span class="text-normal"><span class="user-remark ghh-user-x tooltipstered" style="box-shadow: transparent 0px 0px;">${des}</span></span>`)
    head.after(`<button class="edit-remark btn btn-sm" aria-label="编辑备注" title="编辑备注" data-name="${itemName}" style="margin-left: 10px;"><svg t="1627460177827" class="octicon octicon-star-fill mr-1" viewBox="0 0 1089 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1982" width="16" height="16"><path d="M1062.01504 124.471168 963.208019 25.664192C946.526317 8.982464 923.42857 0 900.330829 0 875.949875 0 854.135341 8.982464 837.453632 25.664192L788.691731 74.426048 788.691731 74.426048 271.558899 591.558912C270.275686 592.842112 268.99248 594.125312 268.99248 595.408512 268.99248 595.408512 268.99248 596.691712 267.709274 596.691712 266.426067 597.974912 266.426067 599.258176 265.142854 600.541376 265.142854 600.541376 265.142854 600.541376 265.142854 601.824576 265.142854 603.107776 265.142854 603.107776 263.859648 604.390976L193.283206 862.315776C190.716794 871.29824 193.283206 881.563904 199.699251 887.979968 204.832083 893.112768 211.248122 895.679168 218.947366 895.679168 221.513786 895.679168 224.080198 895.679168 225.363411 894.395968L484.57143 822.53632C485.854637 822.53632 485.854637 822.53632 487.137843 821.25312L488.42105 821.25312C489.704262 821.25312 490.987469 819.96992 492.270675 818.68672 492.270675 818.68672 493.553882 818.68672 493.553882 817.40352 494.837094 816.12032 496.120301 816.12032 497.403507 814.83712L1013.253133 298.987456 1062.01504 250.225536C1096.661651 216.862144 1096.661651 159.117824 1062.01504 124.471168L1062.01504 124.471168ZM317.754387 813.553856 274.125312 769.9248 303.639098 660.85216 426.827066 784.040128 317.754387 813.553856 317.754387 813.553856ZM328.020051 609.52384 806.65664 130.887232 819.488723 143.719296 863.117792 187.348352 384.481203 665.98496 328.020051 609.52384 328.020051 609.52384ZM478.155386 759.659136 421.694234 703.198016 900.330829 224.561408 956.791981 281.022528 478.155386 759.659136 478.155386 759.659136ZM1023.518797 214.295744 994.005011 243.809536 843.869677 93.674176 874.666669 62.877184C881.082707 56.461184 890.065165 52.61152 900.330829 52.61152 910.596493 52.61152 919.57895 56.461184 925.994989 62.877184L1024.802003 161.684224C1037.634086 177.082688 1037.634086 200.18048 1023.518797 214.295744L1023.518797 214.295744ZM949.09273 476.070144C934.977446 476.070144 922.145363 487.619072 922.145363 503.017536L922.145363 934.175424C922.145363 955.989952 904.180448 973.95488 882.365914 973.95488L153.503757 973.95488C131.689222 973.95488 113.724314 955.989952 113.724314 934.175424L113.724314 204.03008C113.724314 182.215552 131.689222 164.250624 153.503757 164.250624L584.661651 164.250624C598.776941 164.250624 611.609024 152.70176 611.609024 137.303232 611.609024 121.904768 600.060147 110.355904 584.661651 110.355904L153.503757 110.355904C102.175437 110.355904 61.112781 151.41856 61.112781 202.74688L61.112781 931.609024C61.112781 982.937344 102.175437 1024 153.503757 1024L882.365914 1024C933.694234 1024 974.75689 982.937344 974.75689 931.609024L974.75689 503.017536C976.040102 488.902272 964.491226 476.070144 949.09273 476.070144L949.09273 476.070144Z" p-id="1983"></path></svg>Edit</button>`)
  })
  $('button.edit-remark').click(function () {
    const $this = $(this)
    const name = $this.attr('data-name')
    const des = data[name] || ''
    Swal.fire({
      title: `请输入项目"${name}"的备注`,
      input: 'textarea',
      inputValue: des
    }).then(({ value }) => {
      if (value) {
        data[name] = value
        $this.prev().find('span.user-remark').text(value)
      }
      GM_setValue('data', data)
    })
  })

  $('div.flex-items-center>h2').after('<button class="search-remark btn btn-sm" aria-label="搜索备注" title="搜索备注" style="margin-right: 60px;"><svg t="1627546533651" class="octicon octicon-star-fill mr-1" viewBox="0 0 1065 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2361" width="16" height="16"><path d="M48.00416 1023.97952l671.9968 0c26.459631 0 48.00416-21.544529 48.00416-48.00416l0-240.00032c0-0.327673-0.163837-0.573429-0.184316-0.901102 1.761245-1.126377 3.583928-2.170837 5.304214-3.358653l255.544329 255.544329c3.133377 3.133377 7.229295 4.710306 11.325213 4.710306s8.191836-1.576928 11.325213-4.669347c6.246275-6.246275 6.246275-16.383672 0-22.629947l-253.209656-253.209656c40.447191-37.98964 65.882842-91.769045 65.882842-151.48753 0-73.50125-38.440191-138.114358-96.192636-175.100498 0.040959-0.327673 0.184316-0.573429 0.184316-0.901102l0-79.99328c0-0.552949-0.245755-0.98302-0.286714-1.49501-0.061439-0.737265-0.245755-1.372133-0.409592-2.088918-0.552949-2.273235-1.474531-4.321194-2.887622-6.102918-0.225275-0.286714-0.184316-0.634867-0.409592-0.921582l-255.99488-288.00448c-0.102398-0.102398-0.225275-0.102398-0.327673-0.184316-1.925081-2.088918-4.382632-3.461051-7.126897-4.280234-0.614388-0.184316-1.146857-0.266235-1.781724-0.348153-0.921582-0.163837-1.781724-0.552949-2.744265-0.552949l-447.99104 0c-26.459631 0-48.00416 21.544529-48.00416 48.00416l0 927.99168c0 26.459631 21.544529 48.00416 48.00416 48.00416zM831.98336 559.99392c0 97.052779-78.969301 176.0016-176.0016 176.0016s-176.0016-78.948821-176.0016-176.0016 78.969301-176.0016 176.0016-176.0016 176.0016 78.948821 176.0016 176.0016zM511.98976 58.080118l204.386312 229.924362-188.371273 0c-7.044979 0-15.99456-13.434611-15.99456-24.00208l0-205.922282zM32.0096 48.00416c0-8.826703 7.208816-15.99456 15.99456-15.99456l431.99648 0 0 231.9928c0 25.886202 20.950621 55.9912 48.00416 55.9912l207.99072 0 0 48.02464c-24.636947-10.301234-51.649527-16.035519-79.99328-16.035519-58.817384 0-111.859523 24.636947-149.726285 63.99872l-330.274355 0c-8.826703 0-15.99456 7.167857-15.99456 15.99456s7.167857 15.99456 15.99456 15.99456l305.02302 0c-18.083478 28.118478-29.51109 60.824384-32.193916 96.00832l-272.829103 0c-8.826703 0-15.99456 7.167857-15.99456 15.99456s7.167857 15.99456 15.99456 15.99456l272.788144 0c2.682826 35.163457 14.151397 67.869363 32.193916 96.00832l-304.98206 0c-8.826703 0-15.99456 7.167857-15.99456 15.99456s7.167857 15.99456 15.99456 15.99456l328.00112 0c0.675826 0 1.249255-0.286714 1.925081-0.389112 37.887242 39.587048 91.093218 64.387832 150.074439 64.387832 28.343753 0 55.356333-5.734285 79.99328-16.055999l0 224.067199c0 8.826703-7.208816 15.99456-15.99456 15.99456l-671.9968 0c-8.970061 0-15.99456-7.044979-15.99456-15.99456l0-927.99168zM176.0016 319.9936l191.99616 0c8.826703 0 15.99456-7.167857 15.99456-15.99456s-7.167857-15.99456-15.99456-15.99456l-191.99616 0c-8.826703 0-15.99456 7.167857-15.99456 15.99456s7.167857 15.99456 15.99456 15.99456zM176.0016 831.98336l416.00192 0c8.826703 0 15.99456-7.167857 15.99456-15.99456s-7.167857-15.99456-15.99456-15.99456l-416.00192 0c-8.826703 0-15.99456 7.167857-15.99456 15.99456s7.167857 15.99456 15.99456 15.99456z" p-id="2362"></path></svg>Search</button>')
  $('.search-remark').click(async () => {
    const { value: word } = await Swal.fire({
      title: `请输入要搜索的关键词`,
      input: 'text'
    })
    const data = GM_getValue('data') || {}
    const result = []
    for (const [name, value] of Object.entries(data)) {
      const item = (name + value).replace(/[\s]+/g, '')
      if (new RegExp(word, 'gi').test(item)) {
        result.push({ name, value })
      }
    }
    Swal.fire({
      title: `搜索到${result.length}个结果`,
      html: result.map(item => {
        const [, user, repo] = item.name.split('/')
        return `<a href="${item.name}" one-link-mark="yes"><span class="text-normal">${user} / </span>${repo}</a>: ${item.value}`
      }).join('<br/>')
    })
  })

})()
